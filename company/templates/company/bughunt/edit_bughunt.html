{% extends 'company/company_dashboard_base.html' %} 

{% block title %} Add Bughunt {% endblock title %}

{% block body %}

    <div class="bg-[#F3F5F7] flex flex-col items-center">
        <div class="w-full mt-5">
            <p class="text-red-700 font-satoshi font-bold text-[35px] px-8">
            Edit Bughunt
            </p>
        </div>

        <form method='POST' action="#" id="add_bughunt_form" enctype="multipart/form-data" class="w-[96%] bg-white rounded-2xl p-10 my-10 shadow-md">
            {% csrf_token %}

            <input type="text" name="hunt_id" id="hunt_id" hidden value="{{ hunt.id }}">
            <div class="pb-12">
                <h2 class="text-base font-semibold leading-7 text-gray-900">
                    Create new online Bughunt
                </h2>


                <div class="mt-10 grid grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-6">
                    <div class="sm:col-span-3">
                        <label
                        for="bughunt_name"
                        class="block text-sm font-medium leading-6 text-gray-900"
                        >Bughunt Name</label
                        >
                        <div class="mt-2">
                        <input
                            type="text"
                            name="bughunt_name"
                            id="bughunt_name"
                            autocomplete="bughunt_name"
                            placeholder="Hunt 1.0"
                            value="{{ hunt.name }}"
                            required
                            class="block w-full rounded-md border-0 py-1.5 pl-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-red-600 sm:text-sm sm:leading-6"
                        />
                        </div>
                    </div>

                    <div class="sm:col-span-3">
                        <label
                        for="domain_url"
                        class="block text-sm font-medium leading-6 text-gray-900"
                        >Domain Url</label
                        >
                        <div class="mt-2">
                        <input
                            type="text"
                            name="domain_url"
                            id="domain_url"
                            autocomplete="domain_url"
                            placeholder="https://domain.xyz"
                            value="{{ hunt.url }}"
                            required
                            class="block w-full rounded-md border-0 py-1.5 pl-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-red-600 sm:text-sm sm:leading-6"
                        />
                        </div>
                    </div>

                
                    
                <div class="sm:col-span-3">
                    <label
                    for="domain"
                    class="block text-sm font-medium leading-6 text-gray-900 "
                    >Domain</label
                    >
                    <div class="mt-2">
                        <select
                            id="domain"
                            name="domain"
                            value="{{ hunt.domain.id }}"
                            autocomplete="domain-name"
                            class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-red-600 sm:max-w-xs sm:text-sm sm:leading-6"
                        >
                            {% for domain in domains %}
                                <option value="{{ domain.id }}">{{ domain.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.7.0/datepicker.min.js"></script>   
                <div class="sm:col-span-3">
                    <label
                        for="domain_url"
                        class="block text-sm font-medium leading-6 text-gray-900"
                        >Bughunt Timeline</label
                    >
                    <div date-rangepicker class="flex items-center">
                        <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                            <svg class="w-4 h-4 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M20 4a2 2 0 0 0-2-2h-2V1a1 1 0 0 0-2 0v1h-3V1a1 1 0 0 0-2 0v1H6V1a1 1 0 0 0-2 0v1H2a2 2 0 0 0-2 2v2h20V4ZM0 18a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8H0v10Zm5-8h10a1 1 0 0 1 0 2H5a1 1 0 0 1 0-2Z"/>
                            </svg>
                        </div>
                        <input name="start_date" required type="text" value="{{ hunt.starts_on }}" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 p-2.5  " placeholder="Select date start">
                        </div>
                        <span class="mx-4 text-gray-500">to</span>
                        <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                            <svg class="w-4 h-4 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M20 4a2 2 0 0 0-2-2h-2V1a1 1 0 0 0-2 0v1h-3V1a1 1 0 0 0-2 0v1H6V1a1 1 0 0 0-2 0v1H2a2 2 0 0 0-2 2v2h20V4ZM0 18a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8H0v10Zm5-8h10a1 1 0 0 1 0 2H5a1 1 0 0 1 0-2Z"/>
                            </svg>
                        </div>
                        <input name="end_date" required type="text" value="{{ hunt.end_on }}" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 p-2.5  " placeholder="Select date end">
                    </div>
                </div>
                </div>
            </div>

            <div class="space-y-12">
            <div class="border-b border-gray-900/10 pb-12">

                <div class="col-span-full my-5">
                    <label
                    for="bughunt_logo"
                    class="block text-sm font-medium leading-6 text-gray-900"
                    >Bughunt Logo</label
                    >
                    <div class="mt-2 flex items-center gap-x-3" id="previewLogo">
                        <div id="previewLogoDiv" class="h-16 w-16 text-gray-300 overflow-hidden rounded-2xl text-red-500">
                            <img src="{{ MEDIA_URL }}/{{ hunt.logo }}" alt="">
                        </div>
                        <label
                                for="logo"
                                class="relative cursor-pointer rounded-md bg-white font-semibold text-red-600 focus-within:outline-none focus-within:ring-2 focus-within:ring-red-600 focus-within:ring-offset-2 hover:text-red-500"
                            >
                            <span class="text-red-600">Upload logo</span>
                            <input
                            id="logo"
                            name="logo"
                            type="file"
                            class="sr-only"
                            onchange="displayLogoPreview()"
                            />
                        </label>
                    </div>
                </div>

                <div class="col-span-full">
                    <label
                    for="webshot"
                    class="block text-sm font-medium leading-6 text-gray-900"
                    >Banner</label
                    >
                    <div
                    class="mt-2 flex justify-center rounded-lg border border-dashed border-gray-900/25 px-6 py-10 text-red-500"
                    >
                    <div class="text-center">
                        <svg
                        class="mx-auto h-12 w-12"
                        viewBox="0 0 24 24"
                        fill="currentColor"
                        aria-hidden="true"
                        >
                        <path
                            fill-rule="evenodd"
                            d="M1.5 6a2.25 2.25 0 012.25-2.25h16.5A2.25 2.25 0 0122.5 6v12a2.25 2.25 0 01-2.25 2.25H3.75A2.25 2.25 0 011.5 18V6zM3 16.06V18c0 .414.336.75.75.75h16.5A.75.75 0 0021 18v-1.94l-2.69-2.689a1.5 1.5 0 00-2.12 0l-.88.879.97.97a.75.75 0 11-1.06 1.06l-5.16-5.159a1.5 1.5 0 00-2.12 0L3 16.061zm10.125-7.81a1.125 1.125 0 112.25 0 1.125 1.125 0 01-2.25 0z"
                            clip-rule="evenodd"
                        />
                        </svg>
                        <div class="mt-4 flex text-sm leading-6 text-gray-600">
                        <label
                            for="webshot"
                            class="relative cursor-pointer rounded-md bg-white font-semibold text-red-600 focus-within:outline-none focus-within:ring-2 focus-within:ring-red-600 focus-within:ring-offset-2 hover:text-red-500"
                        >
                            <span class="text-red-600">Upload a Banner</span>
                            <input
                            id="webshot"
                            name="webshot"
                            type="file"
                            class="sr-only"
                            />
                        </label>
                        <p class="pl-1">or drag and drop</p>
                        </div>
                        <p class="text-xs leading-5 text-gray-600">
                        PNG, JPG, GIF up to 10MB
                        </p>
                    </div>
                    </div>
                </div>
                </div>
            </div>

            <div class="w-full ">
                {% include "company/company_includes/md_editor.html" %}
            </div>

            <div class="border-b border-gray-900/10 pb-12 mt-5">
                <h2 class="text-base font-semibold leading-7 text-gray-900">
                    Bughunt Prizes
                </h2>

                <div class="bg-gray-100 w-full p-7">
                    <div>
                        <label for="prize_name" class="font-bold"><span class="text-red-500 mr-1">*</span>Prize Name</label>
                        <input type="text" name="prize_name" id="prize_name" placeholder="1st Prize" class="w-full mt-2 px-2 py-2 mb-2 border-[1px] border-gray-200 outline-none">
                    </div>
                    <div class="mt-3">
                        <label for="cash_value" class="font-bold"><span class="text-red-500 mr-1">*</span>Cash Value (USD)</label>
                        <input type="number" min="0" placeholder="1000" name="cash_value" id="cash_value" class="w-full mt-2 px-2 py-2 mb-2 border-[1px] border-gray-200 outline-none">
                    </div>
                                            
                    <div class="mt-3">
                        <label for="number_of_winning_projects" class="font-bold">Number of Winning Projects</label>
                        <input type="number" min="1" id="number_of_winning_projects" name="number_of_winning_projects" class="w-full mt-2 px-2 py-2 mb-2 border-[1px] border-gray-200 outline-none">
                    </div>
                   
                    <div class="mt-2 flex items-center">
                        <input type="checkbox" name="every_valid_submissions" id="every_valid_submissions" class="w-4 h-4">
                        <label for="every_valid_submissions" class="ml-2">Every Valid Submissions are eligible for this prize</label>
                    </div>
                            
                    <script>
                        let valid_s = document.getElementById("every_valid_submissions");
                        let winning_projects = document.getElementById("number_of_winning_projects");
                        valid_s.addEventListener('click',()=>{
                            if (valid_s.checked) {
                                winning_projects.disabled = true;
                                winning_projects.value = 1;
                            } else {
                                winning_projects.disabled = false;
                                winning_projects.value = 1;
                            }
                        })
                    </script>

                    <div class="mt-3">
                        <label for="prize_description" class="font-bold"><span class="text-red-500 mr-1">*</span>Prize Description</label>
                        <textarea type="text" name="prize_description" id="prize_description" class="w-full mt-2 px-2 py-2 mb-2 border border-[1px] border-gray-200 outline-none"></textarea>
                    </div>
                    <div class="mt-3 flex flex-col">
                        <label class="font-bold">Will this prize will be paid in cryptocurrency?</label>
                        <p class="text-[12px] text-gray-700 ml-1">Check below if your prize is paid in cryptocurrency, and list the cash value of the cryptocurrenty and specify the crypto name in Hunt description eg: $100 USD in ETH</p>
                        <div class="mt-2 flex items-center">
                            <input type="checkbox" name="paid_in_cryptocurrency" id="paid_in_cryptocurrency" class="w-4 h-4">
                            <label for="paid_in_cryptocurrency" class="ml-2">The prize will be paid in cryptocurrency</label>
                        </div>
                    </div>

                    <button onclick="add_prize()" type="button" class="w-[120px] h-[40px] mt-8 bg-red-500 text-white font-bold rounded-md hover:bg-red-600 transition-all">
                        Add Prize
                    </button>
                </div>

                <div class="sm:col-span-4 flex overflow-x-scroll" id="list-prize-container">
                    {% for prize in prizes %}
                        <div class="bg-white rounded-lg shadow-lg p-6 w-72 mr-5">
                            <h2 class="text-2xl font-bold mb-4 text-gray-800">{{ prize.name|slice:8 }}...</h2>
                            <div class="mb-4">
                                <p class="text-red-500 font-bold">Cash Value (USD)</p>
                                <p class="text-gray-800">${{ prize.value }}</p>
                            </div>
                            <div class="mb-4">
                                <p class="text-gray-800 font-bold">Number of Winning Projects</p>
                                <p class="text-gray-600">${{ prize.no_of_eligible_projects }}</p>
                            </div>
                            <div class="mb-4">
                                <p class="text-gray-800 font-bold">Reward Valid Submissions</p>
                                <p class="text-gray-600">{{ prize.valid_submissions_eligible }}</p>
                            </div>
                            <div class="mb-4">
                                <p class="text-red-500 font-bold">Prize Description</p>
                                <p class="text-gray-800">{{ prize.description|slice:55 }}...</p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div class="mt-6 flex items-center justify-end gap-x-6">
                <button
                    type="button"
                    onclick="cancelForm()"
                    class="text-md font-semibold leading-6 text-gray-900"
                >
                Cancel
                </button>
                <button
                    type="submit"
                    onclick="PublishBughunt('false')"
                    class="rounded-md bg-gray-600 px-11 py-3 text-md font-semibold text-white shadow-sm hover:bg-gray-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-600"
                >
                Draft
                </button>
                <button
                    type="button"
                    onclick="PublishBughunt('true')"
                    class="rounded-md bg-red-600 px-11 py-3 text-md font-semibold text-white shadow-sm hover:bg-red-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-red-600"
                >
                Publish
                </button>
            </div>
        </div>

        </form>
    </div>
{% endblock %}

{% block js %}
    <script>

        
        let prize_array = [];
        let list_prize_container = document.getElementById("list-prize-container");

        function remove_prize_container(){
            let email_container = document.getElementById("email-container");
            let lst_child = email_container.lastElementChild;
            email_container.removeChild(lst_child);
        }

        function add_prize(){
                        
            let prize_name = document.getElementById("prize_name");
            let cash_value = document.getElementById("cash_value");
            let number_of_winning_projects = document.getElementById("number_of_winning_projects");
            let every_valid_submissions = document.getElementById("every_valid_submissions");
            let prize_description = document.getElementById("prize_description");
            let paid_in_cryptocurrency = document.getElementById("paid_in_cryptocurrency");

            let prize_data = {
                id: prize_array.length,
                prize_name: prize_name.value,
                cash_value: cash_value.value,
                number_of_winning_projects: number_of_winning_projects.value,
                every_valid_submissions: every_valid_submissions.checked,
                prize_description: prize_description.value,
                paid_in_cryptocurrency: paid_in_cryptocurrency.checked
            }
            

            prize_array.push(prize_data)
            alert("Prize added successfully");
            
            prize_name.value = "";
            cash_value.value = 0;
            number_of_winning_projects.value = 1;
            every_valid_submissions.checked = false;
            prize_description.value = "";
            paid_in_cryptocurrency.checked = false;

            const prize_container_child_html = document.createElement('div');
            prize_container_child_html.innerHTML = `
                    <div class="bg-white rounded-lg shadow-lg p-6 w-72 mr-5">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800">${prize_data.prize_name.trim(0,8)}...</h2>
                        <div class="mb-4">
                            <p class="text-red-500 font-bold">Cash Value (USD)</p>
                            <p class="text-gray-800">$1000</p>
                        </div>
                        <div class="mb-4">
                            <p class="text-gray-800 font-bold">Number of Winning Projects</p>
                            <p class="text-gray-600">${prize_data.number_of_winning_projects}</p>
                        </div>
                        <div class="mb-4">
                            <p class="text-gray-800 font-bold">Reward Valid Submission</p>
                            <p class="text-gray-600">${prize_data.every_valid_submissions}</p>
                        </div>
                        <div class="mb-4">
                            <p class="text-red-500 font-bold">Prize Description</p>
                            <p class="text-gray-800">${prize_data.prize_description.trim(0,55)}...</p>
                        </div>
                    </div>
            `;

            list_prize_container.appendChild(prize_container_child_html);
        }

        function cancelForm(){
            let deleteForm = document.getElementById("deleteForm");
            let confirmDelete = confirm("Are you sure you want to cancel, your progress would be lost.");
            if (confirmDelete === true){
                deleteForm.submit();
            }
        }

        function PublishBughunt(is_published){
            
            const bughuntForm = document.getElementById("add_bughunt_form");

            if (bughuntForm.checkValidity()){
                const prizeArrayInput = document.createElement('input');
                prizeArrayInput.type = 'text';
                prizeArrayInput.name = 'prizes';
                prizeArrayInput.value = JSON.stringify(prize_array);
                
                const publishHunt = document.createElement('input');
                publishHunt.type = "text";
                publishHunt.name = "publish_bughunt";
                publishHunt.value = is_published

                bughuntForm.appendChild(prizeArrayInput);
                bughuntForm.appendChild(publishHunt);

                bughuntForm.submit();
            }

            else{
                bughuntForm.reportValidity();
            }

            

        }

        function displayLogoPreview() {
            var fileInput = document.getElementById("logo");
            var previewDiv = document.getElementById("previewLogoDiv");

            if (fileInput.files.length > 0) {
                var file = fileInput.files[0];
                var reader = new FileReader();

                reader.onload = function(event) {
                var preview = document.createElement("img");
                preview.src = event.target.result;
                previewDiv.innerHTML = "";
                previewDiv.appendChild(preview);
                };

                reader.readAsDataURL(file);
            } else {
                previewDiv.innerHTML = "";
            }
        }


    </script>



{% endblock %}